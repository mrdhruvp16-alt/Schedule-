<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Tic-Tac-Toe</title>
    <script src="https://cdn.ably.com/lib/ably.min-js.mjs"></script>
    <style>
        body { font-family: sans-serif; background: #111; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .status { margin-bottom: 20px; font-size: 1.5rem; color: #00d4ff; }
        .grid { display: grid; grid-template-columns: repeat(3, 100px); gap: 10px; }
        .cell { width: 100px; height: 100px; background: #222; border: 2px solid #444; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; cursor: pointer; border-radius: 10px; }
        .cell:hover { background: #333; }
        button { margin-top: 30px; padding: 10px 20px; cursor: pointer; background: #00d4ff; border: none; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="status" id="status">Connecting...</div>
    <div class="grid" id="board">
        <div class="cell" data-index="0"></div>
        <div class="cell" data-index="1"></div>
        <div class="cell" data-index="2"></div>
        <div class="cell" data-index="3"></div>
        <div class="cell" data-index="4"></div>
        <div class="cell" data-index="5"></div>
        <div class="cell" data-index="6"></div>
        <div class="cell" data-index="7"></div>
        <div class="cell" data-index="8"></div>
    </div>
    <button onclick="reset()">Reset Game</button>

    <script type="module">
        // Replace with your real Ably API Key
        const ably = new Ably.Realtime('YOUR_ABLY_API_KEY');
        const channel = ably.channels.get('tic-tac-toe');
        
        const statusDiv = document.getElementById('status');
        const cells = document.querySelectorAll('.cell');
        let board = Array(9).fill("");
        let mySymbol = null;
        let currentTurn = 'X'; // X always starts

        // Check presence to assign X or O
        channel.presence.enter();
        channel.presence.get((err, members) => {
            if (members.length === 1) {
                mySymbol = 'X';
                statusDiv.innerText = "You are X - You go first!";
            } else if (members.length === 2) {
                mySymbol = 'O';
                statusDiv.innerText = "You are O - Wait for X";
            } else {
                statusDiv.innerText = "Spectating...";
            }
        });

        // Handle incoming moves
        channel.subscribe('move', (msg) => {
            const { index, symbol } = msg.data;
            board[index] = symbol;
            cells[index].innerText = symbol;
            currentTurn = (symbol === 'X') ? 'O' : 'X';
            updateStatus();
            checkWin();
        });

        // Handle clicking
        cells.forEach(cell => {
            cell.addEventListener('click', () => {
                const idx = cell.getAttribute('data-index');
                if (board[idx] === "" && mySymbol === currentTurn) {
                    channel.publish('move', { index: idx, symbol: mySymbol });
                }
            });
        });

        function updateStatus() {
            if (!mySymbol) return;
            statusDiv.innerText = (currentTurn === mySymbol) ? "Your Turn!" : `Waiting for ${currentTurn}...`;
        }

        function checkWin() {
            const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for (let [a,b,c] of lines) {
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    statusDiv.innerText = `Player ${board[a]} Wins!`;
                    mySymbol = "GAME_OVER"; 
                }
            }
        }

        window.reset = () => channel.publish('reset', {});
        channel.subscribe('reset', () => location.reload());
    </script>
</body>
</html>
